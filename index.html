<!doctype html>
<html lang="en">
  <head>
    <title>&lt;model-viewer&gt; template</title>
    <meta charset="utf-8">
    <meta name="description" content="&lt;model-viewer&gt; template">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link type="text/css" href="./styles.css" rel="stylesheet"/>
    <script type="module">
    const modelViewer = document.querySelector('model-viewer');
    const hotspotsContainer = document.querySelector('.hotspots-container');
    const hotspots = [];

    modelViewer.addEventListener('click', event => {
      const { clientX, clientY } = event;

      // Get the canvas where the model is rendered
      const canvas = modelViewer.shadowRoot.querySelector('canvas');

      // Calculate the mouse position relative to the canvas
      const canvasRect = canvas.getBoundingClientRect();
      const x = (clientX - canvasRect.left) / canvasRect.width;
      const y = (clientY - canvasRect.top) / canvasRect.height;

      // Convert 2D coordinates to 3D coordinates
      const { detail } = modelViewer.positionAndNormalFromPoint(x, y);

      if (detail) {
        const { position, normal } = detail;

        // Create hotspot element
        const hotspot = document.createElement('div');
        hotspot.classList.add('hotspot');
        hotspot.style.left = `${clientX}px`;
        hotspot.style.top = `${clientY}px`;

        // Add a marker or icon for the hotspot
        hotspot.innerHTML = 'H'; // You can replace this with your preferred marker or icon

        // Store the hotspot data
        const hotspotData = {
          position: position,
          marker: 'H', // You can store the marker/icon information here
        };
        hotspots.push(hotspotData);

        hotspot.addEventListener('click', () => {
          // Handle click on the hotspot (e.g., show details or perform an action)
          alert('Hotspot clicked!');
        });

        hotspot.addEventListener('contextmenu', (e) => {
          // Prevent the default context menu (right-click menu)
          e.preventDefault();
          
          // Handle right-click on the hotspot (e.g., delete the hotspot)
          const index = hotspots.indexOf(hotspotData);
          if (index !== -1) {
            hotspotsContainer.removeChild(hotspot);
            hotspots.splice(index, 1);
          }
        });

        hotspotsContainer.appendChild(hotspot);
      }
    });

    // Function to save hotspots
    function saveHotspots() {
      // Serialize the hotspots data and save it to storage (e.g., localStorage)
      localStorage.setItem('hotspots', JSON.stringify(hotspots));
      console.log('Hotspots saved.');
    }

    // Function to load hotspots
    function loadHotspots() {
      // Load the hotspots data from storage (e.g., localStorage)
      const savedHotspots = localStorage.getItem('hotspots');
      if (savedHotspots) {
        hotspots.push(...JSON.parse(savedHotspots));

        // Display saved hotspots
        hotspots.forEach(hotspotData => {
          const { position, marker } = hotspotData;

          const hotspot = document.createElement('div');
          hotspot.classList.add('hotspot');
          hotspot.innerHTML = marker;
          hotspotsContainer.appendChild(hotspot);

          hotspot.addEventListener('click', () => {
            alert('Hotspot clicked!');
          });
        });

        console.log('Hotspots loaded.');
      }
    }

    // Load hotspots when the page loads
    loadHotspots();

    // Save hotspots when the user requests it (e.g., button click)
    document.querySelector('#saveHotspotsButton').addEventListener('click', saveHotspots);
  </script>
  <style>
    .hotspots-container {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .hotspot {
      position: absolute;
      font-size: 20px;
      color: red;
      cursor: pointer;
      user-select: none;
    }

    #saveHotspotsButton {
      margin-top: 10px;
      padding: 5px 10px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #saveHotspotsButton:hover {
      background-color: #0056b3;
    }
  </style>
  </head>
  <body>
    <!-- <model-viewer> HTML element -->
    <model-viewer src="renault_clio_rs.glb" ar ar-modes="scene-viewer quick-look" camera-controls poster="poster.webp" shadow-intensity="1">
      <div class="progress-bar hide" slot="progress-bar">
          <div class="update-bar"></div>
      </div>
      <button slot="ar-button" id="ar-button">
          View in your space
      </button>
      <div id="ar-prompt">
          <img src="ar_hand_prompt.png">
      </div>
    </model-viewer>  
    <div class="hotspots-container"></div>
    <button id="saveHotspotsButton">Save Hotspots</button>
    <script src="script.js"></script>
    <!-- Loads <model-viewer> for browsers: -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.2.0/model-viewer.min.js"></script>
  </body>
</html>
